box: wercker/ruby

build:
    steps:
      - wercker/install-packages@0.0.4

      - install-packages:
        packages: cmake

deploy:
    steps:
      
      - add-to-known_hosts:
          hostname: tk2-213-16244.vs.sakura.ne.jp

      - mktemp:
          envvar: PRIVATEKEY_PATH    

      # werckerで設定したsshの秘密鍵の環境変数を基に秘密鍵を生成
      - create-file:
          name: Create private key
          filename: $PRIVATEKEY_PATH
          content: $DEPLOY_KEY_PRIVATE
          overwrite: true

      # 「/pipeline/source/」ディレクトリにソースがあるのでそれをtar + sshでサーバーに転送
      - script:
          name: Transfer data
          code: |
            PORT=${PORT}
            USER=${USER}
            tar cvz /pipeline/source/* | ssh -i $PRIVATEKEY_PATH -p $PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=no tk2-213-16244.vs.sakura.ne.jp tar zxv -C /home/$USER/